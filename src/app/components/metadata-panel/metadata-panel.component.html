@if (isOpen()) {
  <div [ngClass]="panelClasses()">
    <div class="flex items-center justify-between px-6 py-4 gap-4 border-b border-base-300">
      <div class="flex-1 min-w-0">
        @if (searchResult(); as result) {
          <h2 class="text-lg font-semibold truncate">
            {{ result._source.url_query }}
          </h2>
          <a
            [href]="result._source.capture.url"
            target="_blank"
            rel="noopener noreferrer"
            class="text-sm text-primary hover:underline truncate block"
          >
            {{ result._source.capture.url }}
          </a>
        } @else {
          <h2 class="text-lg font-semibold">Metadata Panel</h2>
        }
      </div>
      <aql-button
        iconStyle="square"
        iconBefore="bi-x-lg"
        size="md"
        (buttonClick)="onClose()"
        class="flex-shrink-0"
      ></aql-button>
    </div>

    <div class="px-6 pt-4 border-b border-base-300">
      <aql-tab-menu
        [tabs]="tabs"
        [activeTabId]="activeTab()"
        [size]="'sm'"
        [tabStyle]="'border'"
        (tabChange)="onTabChange($event)"
      ></aql-tab-menu>
    </div>

    <div class="flex-1 overflow-y-auto">
      @switch (activeTab()) {
        @case ('text') {
          <div class="p-6">
            <div class="mb-4">
              <h3 class="text-sm font-semibold uppercase text-base-content/60 mb-2">
                Plain Text View
              </h3>
              <p class="text-sm text-base-content/80 leading-relaxed whitespace-pre-line">
                {{ getExtractionText() }}
              </p>
            </div>
          </div>
        }
        @case ('html') {
          <div class="p-6">
            <div class="mb-4">
              <h3 class="text-sm font-semibold uppercase text-base-content/60 mb-2">HTML View</h3>
              @if (searchResult(); as result) {
                <div class="bg-base-200 rounded-lg p-4">
                  <code class="text-xs">
                    <pre class="whitespace-pre-wrap break-words">{{ result._source | json }}</pre>
                  </code>
                </div>
              }
            </div>
          </div>
        }
        @case ('website') {
          <div class="p-6">
            <div class="space-y-4">
              <h3 class="text-sm font-semibold uppercase text-base-content/60">
                Archived Website Preview
              </h3>
              @if (searchResult(); as result) {
                <div class="space-y-3 text-sm">
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="flex flex-row text-base-content/70 gap-1">
                      <i class="bi bi-clock-history me-1"></i>Snapshot Date:
                    </span>
                    <span>{{ archiveDate() }}</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="flex flex-row font-semibold text-base-content/70 gap-1">
                      <i class="bi bi-archive me-1"></i>Archive:
                    </span>
                    <span class="text-xs break-all">{{
                      result._source.archive?.memento_api_url || 'N/A'
                    }}</span>
                  </div>
                  <div class="flex justify-between items-center py-2 border-b border-base-300">
                    <span class="flex flex-row font-semibold text-base-content/70 gap-1">
                      <i class="bi bi-box-arrow-up-right me-1"></i>Open Snapshot:
                    </span>
                    <a
                      [href]="mementoUrlString()"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-primary hover:underline text-xs"
                    >
                      Open in new tab <i class="bi bi-arrow-right"></i>
                    </a>
                  </div>
                </div>
                @if (mementoUrl(); as url) {
                  <div class="relative mt-4">
                    @if (isIframeLoading() && !iframeError()) {
                      <div
                        class="absolute inset-0 flex items-center justify-center bg-base-200 rounded-lg border border-base-300 z-10"
                      >
                        <div class="flex flex-col items-center gap-3">
                          <span class="loading loading-spinner loading-lg text-primary"></span>
                          <p class="text-sm text-base-content/70">Loading archived snapshot...</p>
                        </div>
                      </div>
                    }
                    @if (iframeError()) {
                      <div
                        class="absolute inset-0 flex items-center justify-center bg-base-200 rounded-lg border border-error z-10"
                      >
                        <div class="flex flex-col items-center gap-3 text-error">
                          <i class="bi bi-exclamation-triangle text-4xl"></i>
                          <p class="text-sm font-semibold">Failed to load archived snapshot</p>
                          <p class="text-xs text-base-content/60">
                            The archive may be unavailable or blocked
                          </p>
                        </div>
                      </div>
                    }
                    <iframe
                      [src]="url"
                      class="w-full h-[500px] border border-base-300 rounded-lg"
                      sandbox="allow-scripts allow-same-origin allow-popups"
                      referrerpolicy="no-referrer"
                      loading="eager"
                      [title]="'Archived website snapshot from ' + archiveDate()"
                      (load)="onIframeLoad()"
                      (error)="onIframeError()"
                    ></iframe>
                  </div>
                }
                <p class="text-xs text-base-content/50 mt-3">
                  <i class="bi bi-info-circle me-1"></i>
                  This preview shows how the website appeared at the time of archival.
                </p>
              }
            </div>
          </div>
        }
        @case ('metadata') {
          <div class="p-6">
            <div class="space-y-4">
              <h3 class="text-sm font-semibold uppercase text-base-content/60">Metadata</h3>
              @if (searchResult(); as result) {
                <div class="space-y-3 text-sm">
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="font-semibold text-base-content/70">Score:</span>
                    <span>{{ result._score | number: '1.2-2' }}</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="font-semibold text-base-content/70">Document ID:</span>
                    <span class="text-xs break-all">{{ result._id }}</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="font-semibold text-base-content/70">MIME Type:</span>
                    <span>{{ result._source.capture.mimetype }}</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="font-semibold text-base-content/70">Timestamp:</span>
                    <span>{{ result._source.capture.timestamp }}</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="font-semibold text-base-content/70">Provider:</span>
                    <span>{{ result._source.provider.domain }}</span>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      }
    </div>
  </div>
}
