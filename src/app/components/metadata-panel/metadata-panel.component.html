@if (isOpen()) {
  <div [ngClass]="panelClasses()">
    <div class="flex items-center justify-between px-6 py-4 gap-4 border-b border-base-300">
      <div class="flex-1 min-w-0">
        @if (searchResult(); as result) {
          <h2 class="text-lg font-semibold truncate">
            {{ result._source.url_query }}
          </h2>
          <a
            [href]="result._source.capture.url"
            target="_blank"
            rel="noopener noreferrer"
            class="text-sm text-primary hover:underline truncate block"
          >
            {{ result._source.capture.url }}
          </a>
        } @else {
          <h2 class="text-lg font-semibold">{{ 'metadata.panel' | translate }}</h2>
        }
      </div>
      <aql-button
        iconStyle="square"
        iconBefore="bi-x-lg"
        size="md"
        (buttonClick)="onClose()"
        class="flex-shrink-0"
      ></aql-button>
    </div>

    <div class="px-6 pt-4 border-b border-base-300">
      <aql-tab-menu
        [tabs]="tabs()"
        [activeTabId]="activeTab()"
        [size]="'sm'"
        [tabStyle]="'border'"
        (tabChange)="onTabChange($event)"
      ></aql-tab-menu>
    </div>

    <div class="flex-1 overflow-y-auto">
      @switch (activeTab()) {
        @case ('text') {
          <div class="p-6">
            <div class="mb-4">
              <h3 class="text-sm font-semibold uppercase text-base-content/60 mb-2">
                {{ 'metadata.plainTextView' | translate }}
              </h3>
              <p class="text-sm text-base-content/80 leading-relaxed whitespace-pre-line">
                {{ getExtractionText() }}
              </p>
            </div>
          </div>
        }
        @case ('html') {
          <div class="p-6">
            <div class="mb-4">
              <h3 class="text-sm font-semibold uppercase text-base-content/60 mb-2">
                {{ 'metadata.htmlView' | translate }}
              </h3>
              @if (searchResult(); as result) {
                <div class="bg-base-200 rounded-lg p-4">
                  <code class="text-xs">
                    <pre class="whitespace-pre-wrap break-words">{{ result._source | json }}</pre>
                  </code>
                </div>
              }
            </div>
          </div>
        }
        @case ('website') {
          <div class="p-6">
            <div class="space-y-4">
              <h3 class="text-sm font-semibold uppercase text-base-content/60">
                {{ 'metadata.websitePreview' | translate }}
              </h3>
              @if (searchResult(); as result) {
                <div class="space-y-3 text-sm">
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="flex flex-row text-base-content/70 gap-1">
                      <i class="bi bi-clock-history me-1"></i>Snapshot Date:
                    </span>
                    <span>{{ archiveDate() }}</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="flex flex-row font-semibold text-base-content/70 gap-1">
                      <i class="bi bi-archive me-1"></i>Archive:
                    </span>
                    <span class="text-xs break-all">{{
                      result._source.archive?.memento_api_url || 'N/A'
                    }}</span>
                  </div>
                  <div class="flex justify-between items-center py-2 border-b border-base-300">
                    <span class="flex flex-row font-semibold text-base-content/70 gap-1">
                      <i class="bi bi-box-arrow-up-right me-1"></i>Open Snapshot:
                    </span>
                    <a
                      [href]="mementoUrlString()"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-primary hover:underline text-xs"
                    >
                      Open in new tab <i class="bi bi-arrow-right"></i>
                    </a>
                  </div>
                </div>
                @if (mementoUrl(); as url) {
                  <div class="relative mt-4">
                    @if (isIframeLoading() && !iframeError()) {
                      <div
                        class="absolute inset-0 flex items-center justify-center bg-base-200 rounded-lg border border-base-300 z-10"
                      >
                        <div class="flex flex-col items-center gap-3">
                          <span class="loading loading-spinner loading-lg text-primary"></span>
                          <p class="text-sm text-base-content/70">Loading archived snapshot...</p>
                        </div>
                      </div>
                    }
                    @if (iframeError()) {
                      <div
                        class="absolute inset-0 flex items-center justify-center bg-base-200 rounded-lg border border-error z-10"
                      >
                        <div class="flex flex-col items-center gap-3 text-error">
                          <i class="bi bi-exclamation-triangle text-4xl"></i>
                          <p class="text-sm font-semibold">Failed to load archived snapshot</p>
                          <p class="text-xs text-base-content/60">
                            The archive may be unavailable or blocked
                          </p>
                        </div>
                      </div>
                    }
                    <iframe
                      [src]="url"
                      class="w-full h-[500px] border border-base-300 rounded-lg"
                      sandbox="allow-scripts allow-same-origin allow-popups"
                      referrerpolicy="no-referrer"
                      loading="eager"
                      [title]="'Archived website snapshot from ' + archiveDate()"
                      (load)="onIframeLoad()"
                      (error)="onIframeError()"
                    ></iframe>
                  </div>
                }
                <p class="text-xs text-base-content/50 mt-3">
                  <i class="bi bi-info-circle me-1"></i>
                  This preview shows how the website appeared at the time of archival.
                </p>
              }
            </div>
          </div>
        }
        @case ('metadata') {
          <div class="p-6">
            <div class="space-y-4">
              <h3 class="text-sm font-semibold uppercase text-base-content/60">
                {{ 'metadata.metadata' | translate }}
              </h3>
              @if (searchResult(); as result) {
                <div class="space-y-3 text-sm">
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="font-semibold text-base-content/70"
                      >{{ 'metadata.score' | translate }}:</span
                    >
                    <span>{{ result._score | number: '1.2-2' }}</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="font-semibold text-base-content/70"
                      >{{ 'metadata.documentId' | translate }}:</span
                    >
                    <span class="text-xs break-all">{{ result._id }}</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="font-semibold text-base-content/70"
                      >{{ 'metadata.mimeType' | translate }}:</span
                    >
                    <span>{{ result._source.capture.mimetype }}</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="font-semibold text-base-content/70"
                      >{{ 'metadata.timestamp' | translate }}:</span
                    >
                    <span>{{ result._source.capture.timestamp }}</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="font-semibold text-base-content/70"
                      >{{ 'metadata.provider' | translate }}:</span
                    >
                    <span>{{ result._source.provider.domain }}</span>
                  </div>
                </div>
              }
            </div>
          </div>
        }
        @case ('related') {
          <div class="p-6">
            <div class="space-y-4">
              <h3 class="text-sm font-semibold uppercase text-base-content/60">
                {{ 'metadata.relatedSerps' | translate }}
              </h3>
              @if (isLoadingDetails()) {
                <div class="flex items-center justify-center py-8">
                  <span class="loading loading-spinner loading-md text-primary"></span>
                </div>
              } @else if (relatedSerps().length > 0) {
                <div class="related-serps-list space-y-3">
                  @for (serp of relatedSerps(); track serp._id) {
                    <app-related-serp-card
                      [serp]="serp"
                      (serpClick)="onRelatedSerpClick($event)"
                    ></app-related-serp-card>
                  }
                </div>
              } @else {
                <div class="text-center py-8 text-base-content/50">
                  <i class="bi bi-search text-4xl mb-3 block"></i>
                  <p>{{ 'metadata.noRelatedSerps' | translate }}</p>
                </div>
              }
            </div>
          </div>
        }
        @case ('unfurl') {
          <div class="p-6">
            <div class="space-y-4">
              <div class="flex justify-between items-center">
                <h3 class="text-sm font-semibold uppercase text-base-content/60">
                  {{ 'metadata.urlDetails' | translate }}
                </h3>
                @if (unfurlWebUrl()) {
                  <a
                    [href]="unfurlWebUrl()"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center gap-1 text-sm text-primary hover:underline"
                  >
                    {{ 'metadata.unfurl.viewInUnfurlTool' | translate }}
                    <i class="bi bi-box-arrow-up-right"></i>
                  </a>
                }
              </div>
              @if (isLoadingDetails()) {
                <div class="flex items-center justify-center py-8">
                  <span class="loading loading-spinner loading-md text-primary"></span>
                </div>
              } @else if (unfurlData(); as unfurl) {
                <div class="unfurl-view space-y-4">
                  <!-- Scheme -->
                  <div class="unfurl-section">
                    <h4 class="text-xs font-semibold uppercase text-base-content/50 mb-2">
                      {{ 'metadata.unfurl.protocol' | translate }}
                    </h4>
                    <code class="block p-3 bg-base-200 rounded-lg text-sm font-mono break-all">
                      {{ unfurl.scheme }}
                    </code>
                  </div>

                  <!-- Domain Parts -->
                  <div class="unfurl-section">
                    <h4 class="text-xs font-semibold uppercase text-base-content/50 mb-2">
                      {{ 'metadata.unfurl.domain' | translate }}
                    </h4>
                    <code class="block p-3 bg-base-200 rounded-lg text-sm font-mono break-all">
                      {{ unfurl.netloc }}
                    </code>
                    @if (unfurl.domain_parts) {
                      <div class="mt-2 grid grid-cols-2 gap-2 text-xs">
                        @if (unfurl.domain_parts.subdomain) {
                          <div class="p-2 bg-base-200/50 rounded">
                            <span class="text-base-content/50">Subdomain:</span>
                            <span class="ms-1 font-mono">{{ unfurl.domain_parts.subdomain }}</span>
                          </div>
                        }
                        <div class="p-2 bg-base-200/50 rounded">
                          <span class="text-base-content/50">Domain:</span>
                          <span class="ms-1 font-mono">{{ unfurl.domain_parts.domain }}</span>
                        </div>
                        <div class="p-2 bg-base-200/50 rounded">
                          <span class="text-base-content/50">TLD:</span>
                          <span class="ms-1 font-mono">{{ unfurl.domain_parts.suffix }}</span>
                        </div>
                      </div>
                    }
                  </div>

                  <!-- Port (if present) -->
                  @if (unfurl.port) {
                    <div class="unfurl-section">
                      <h4 class="text-xs font-semibold uppercase text-base-content/50 mb-2">
                        {{ 'metadata.unfurl.port' | translate }}
                      </h4>
                      <code class="block p-3 bg-base-200 rounded-lg text-sm font-mono">
                        {{ unfurl.port }}
                      </code>
                    </div>
                  }

                  <!-- Path -->
                  <div class="unfurl-section">
                    <h4 class="text-xs font-semibold uppercase text-base-content/50 mb-2">
                      {{ 'metadata.unfurl.path' | translate }}
                    </h4>
                    <code class="block p-3 bg-base-200 rounded-lg text-sm font-mono break-all">
                      {{ unfurl.path || '/' }}
                    </code>
                    @if (unfurl.path_segments && unfurl.path_segments.length > 0) {
                      <div class="mt-2 flex flex-wrap gap-1">
                        @for (segment of unfurl.path_segments; track $index) {
                          <span
                            class="px-2 py-1 bg-primary/10 text-primary rounded text-xs font-mono"
                          >
                            /{{ segment }}
                          </span>
                        }
                      </div>
                    }
                  </div>

                  <!-- Query Parameters -->
                  @if (getQueryParamEntries().length > 0) {
                    <div class="unfurl-section">
                      <h4 class="text-xs font-semibold uppercase text-base-content/50 mb-2">
                        {{ 'metadata.unfurl.queryParams' | translate }}
                      </h4>
                      <div class="overflow-x-auto">
                        <table class="table table-sm w-full">
                          <thead>
                            <tr class="border-b border-base-300">
                              <th class="text-left font-semibold text-base-content/70">
                                {{ 'metadata.unfurl.parameter' | translate }}
                              </th>
                              <th class="text-left font-semibold text-base-content/70">
                                {{ 'metadata.unfurl.value' | translate }}
                              </th>
                            </tr>
                          </thead>
                          <tbody>
                            @for (param of getQueryParamEntries(); track param.key) {
                              <tr class="border-b border-base-300/50">
                                <td class="font-mono text-sm text-primary">{{ param.key }}</td>
                                <td class="font-mono text-sm break-all">{{ param.value }}</td>
                              </tr>
                            }
                          </tbody>
                        </table>
                      </div>
                    </div>
                  }

                  <!-- Fragment -->
                  @if (unfurl.fragment) {
                    <div class="unfurl-section">
                      <h4 class="text-xs font-semibold uppercase text-base-content/50 mb-2">
                        {{ 'metadata.unfurl.fragment' | translate }}
                      </h4>
                      <code class="block p-3 bg-base-200 rounded-lg text-sm font-mono break-all">
                        #{{ unfurl.fragment }}
                      </code>
                    </div>
                  }
                </div>
              } @else {
                <div class="text-center py-8 text-base-content/50">
                  <i class="bi bi-link-45deg text-4xl mb-3 block"></i>
                  <p>{{ 'metadata.noUnfurlData' | translate }}</p>
                </div>
              }
            </div>
          </div>
        }
      }
    </div>
  </div>
}
