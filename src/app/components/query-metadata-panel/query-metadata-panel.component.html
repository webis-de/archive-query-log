<div [ngClass]="panelClasses()">
  <div [ngClass]="contentWrapperClasses()" class="h-full flex flex-col">
    <div
      class="flex items-center justify-between px-6 py-4 gap-4 border-b border-base-300 flex-shrink-0"
    >
      <div class="flex-1 min-w-0">
        @if (isLoading()) {
          <h2 class="text-lg font-semibold animate-pulse bg-base-300 h-7 w-2/3 rounded">
            <span class="sr-only">Loading...</span>
          </h2>
        } @else if (searchResult(); as result) {
          <h2 class="text-lg font-semibold truncate">
            {{ result._source.url_query }}
          </h2>
          <a
            [href]="result._source.capture.url"
            target="_blank"
            rel="noopener noreferrer"
            class="text-sm text-primary hover:underline truncate block"
          >
            {{ result._source.capture.url }}
          </a>
        } @else if (providerDetail(); as provider) {
          <h2 class="text-lg font-semibold truncate">
            {{ provider.name }}
          </h2>
          <p class="text-sm text-base-content/60 font-mono truncate">
            {{ provider.id }}
          </p>
        } @else if (archiveDetail(); as archive) {
          <h2 class="text-lg font-semibold truncate">
            {{ archive.name }}
          </h2>
          <a
            [href]="archive.id"
            target="_blank"
            rel="noopener noreferrer"
            class="text-sm text-primary hover:underline truncate block"
          >
            {{ archive.id }}
          </a>
        } @else if (error()) {
          <h2 class="text-lg font-semibold text-error">{{ 'common.error' | translate }}</h2>
        } @else {
          <h2 class="text-lg font-semibold">{{ 'metadata.panel' | translate }}</h2>
        }
      </div>
      <div class="flex gap-2 flex-shrink-0">
        @if (history().length > 0) {
          <aql-button
            iconStyle="square"
            iconBefore="bi-arrow-left"
            size="md"
            [aqlTooltip]="'tooltip.metadata.backOne' | translate"
            [tooltipPosition]="'top'"
            [attr.aria-label]="'metadata.backOne' | translate"
            (buttonClick)="onBackOne()"
          ></aql-button>
        }
        @if (isViewingRelatedSerp()) {
          <aql-button
            iconStyle="square"
            iconBefore="bi-arrow-bar-left"
            size="md"
            [aqlTooltip]="'tooltip.metadata.backToOriginal' | translate"
            [tooltipPosition]="'top'"
            [attr.aria-label]="'metadata.backToOriginal' | translate"
            (buttonClick)="onBackToOriginal()"
          ></aql-button>
        }
        <aql-button
          iconStyle="square"
          iconBefore="bi-x-lg"
          size="md"
          (buttonClick)="onClose()"
        ></aql-button>
      </div>
    </div>

    @if (isLoading()) {
      <div class="flex-1 flex items-center justify-center">
        <span class="loading loading-spinner loading-lg text-primary"></span>
      </div>
    } @else if (error(); as err) {
      <div class="flex-1 flex flex-col items-center justify-center p-8 text-center opacity-60">
        <i class="bi bi-exclamation-triangle text-4xl mb-4 text-error"></i>
        <p class="text-lg font-semibold">{{ err }}</p>
      </div>
    } @else if (!hasContent()) {
      <div class="flex-1 flex flex-col items-center justify-center p-8 text-center opacity-60">
        <i class="bi bi-inbox text-4xl mb-4"></i>
        <p class="text-lg font-semibold">{{ 'metadata.noDataSelected' | translate }}</p>
      </div>
    } @else {
      <div class="px-6 pt-4 border-b border-base-300">
        <aql-tab-menu
          [tabs]="tabs()"
          [activeTabId]="activeTab()"
          [size]="'sm'"
          [tabStyle]="'border'"
          (tabChange)="onTabChange($event)"
        ></aql-tab-menu>
      </div>

      <div class="flex-1 overflow-y-auto">
        @switch (activeTab()) {
          @case ('html') {
            <app-metadata-html-tab [searchResult]="searchResult()"></app-metadata-html-tab>
          }
          @case ('website') {
            <app-metadata-website-tab
              [searchResult]="searchResult()"
              [isActive]="activeTab() === 'website'"
            ></app-metadata-website-tab>
          }
          @case ('metadata') {
            <app-metadata-info-tab [searchResult]="searchResult()"></app-metadata-info-tab>
          }
          @case ('related') {
            <app-metadata-related-tab
              [relatedSerps]="relatedSerps()"
              [isLoading]="isLoadingDetails()"
              (serpSelected)="onRelatedSerpClick($event)"
            ></app-metadata-related-tab>
          }
          @case ('unfurl') {
            <app-metadata-unfurl-tab
              [unfurlData]="unfurlData()"
              [unfurlWebUrl]="unfurlWebUrl()"
              [isLoading]="isLoadingDetails()"
            ></app-metadata-unfurl-tab>
          }
          @case ('provider-info') {
            <app-metadata-provider-tab
              [providerDetail]="providerDetail()"
            ></app-metadata-provider-tab>
          }
          @case ('archive-info') {
            <app-metadata-archive-tab [archiveDetail]="archiveDetail()"></app-metadata-archive-tab>
          }
          @case ('statistics') {
            @if (providerDetail(); as provider) {
              <app-metadata-statistics-tab
                [entityId]="provider.id"
                [type]="'provider'"
              ></app-metadata-statistics-tab>
            } @else if (archiveDetail(); as archive) {
              <app-metadata-statistics-tab
                [entityId]="archive.id"
                [type]="'archive'"
              ></app-metadata-statistics-tab>
            }
          }
        }
      </div>
    }
  </div>
</div>
