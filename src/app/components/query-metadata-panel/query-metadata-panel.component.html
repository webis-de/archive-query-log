<div [ngClass]="panelClasses()">
  <div [ngClass]="contentWrapperClasses()" class="h-full flex flex-col">
    <div
      class="flex items-center justify-between px-6 py-4 gap-4 border-b border-base-300 flex-shrink-0"
    >
      <div class="flex-1 min-w-0">
        @if (searchResult(); as result) {
          <h2 class="text-lg font-semibold truncate">
            {{ result._source.url_query }}
          </h2>
          <a
            [href]="result._source.capture.url"
            target="_blank"
            rel="noopener noreferrer"
            class="text-sm text-primary hover:underline truncate block"
          >
            {{ result._source.capture.url }}
          </a>
        } @else {
          <h2 class="text-lg font-semibold">{{ 'metadata.panel' | translate }}</h2>
        }
      </div>
      <div class="flex gap-2 flex-shrink-0">
        @if (history().length > 0) {
          <aql-button
            iconStyle="square"
            iconBefore="bi-arrow-left"
            size="md"
            [aqlTooltip]="'tooltip.metadata.backOne' | translate"
            [tooltipPosition]="'top'"
            [attr.aria-label]="'metadata.backOne' | translate"
            (buttonClick)="onBackOne()"
          ></aql-button>
        }
        @if (isViewingRelatedSerp()) {
          <aql-button
            iconStyle="square"
            iconBefore="bi-arrow-bar-left"
            size="md"
            [aqlTooltip]="'tooltip.metadata.backToOriginal' | translate"
            [tooltipPosition]="'top'"
            [attr.aria-label]="'metadata.backToOriginal' | translate"
            (buttonClick)="onBackToOriginal()"
          ></aql-button>
        }
        <aql-button
          iconStyle="square"
          iconBefore="bi-x-lg"
          size="md"
          (buttonClick)="onClose()"
        ></aql-button>
      </div>
    </div>

    <div class="px-6 pt-4 border-b border-base-300">
      <aql-tab-menu
        [tabs]="tabs()"
        [activeTabId]="activeTab()"
        [size]="'sm'"
        [tabStyle]="'border'"
        (tabChange)="onTabChange($event)"
      ></aql-tab-menu>
    </div>

    <div class="flex-1 overflow-y-auto">
      @switch (activeTab()) {
        @case ('text') {
          <div class="p-6">
            <div class="mb-4">
              <h3 class="text-sm font-semibold uppercase text-base-content/60 mb-2">
                {{ 'metadata.plainTextView' | translate }}
              </h3>
              <p class="text-sm text-base-content/80 leading-relaxed whitespace-pre-line">
                {{ getExtractionText() }}
              </p>
            </div>
          </div>
        }
        @case ('html') {
          <div class="p-6">
            <div class="mb-4">
              <h3 class="text-sm font-semibold uppercase text-base-content/60 mb-2">
                {{ 'metadata.htmlView' | translate }}
              </h3>
              @if (searchResult(); as result) {
                <div class="bg-base-200 rounded-lg p-4">
                  <code class="text-xs">
                    <pre class="whitespace-pre-wrap break-words">{{ result._source | json }}</pre>
                  </code>
                </div>
              }
            </div>
          </div>
        }
        @case ('website') {
          <div class="p-6">
            <div class="space-y-4">
              <h3 class="text-sm font-semibold uppercase text-base-content/60">
                {{ 'metadata.websitePreview' | translate }}
              </h3>
              @if (searchResult(); as result) {
                <div class="space-y-3 text-sm">
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="flex flex-row text-base-content/70 gap-1">
                      <i class="bi bi-clock-history me-1"></i
                      >{{ 'metadata.website.snapshotDate' | translate }}
                    </span>
                    <span>{{ archiveDate() }}</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="flex flex-row font-semibold text-base-content/70 gap-1">
                      <i class="bi bi-archive me-1"></i>{{ 'metadata.website.archive' | translate }}
                    </span>
                    <span class="text-xs break-all">{{ archiveName() }}</span>
                  </div>
                  @if (archiveHomepage(); as homepage) {
                    <div class="flex justify-between items-center py-2 border-b border-base-300">
                      <span class="flex flex-row font-semibold text-base-content/70 gap-1">
                        <i class="bi bi-house me-1"></i
                        >{{ 'metadata.website.homepage' | translate }}
                      </span>
                      <a
                        [href]="homepage"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-primary hover:underline text-xs"
                      >
                        {{ homepage }}
                        <i class="bi bi-box-arrow-up-right ms-1"></i>
                      </a>
                    </div>
                  }
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="flex flex-row font-semibold text-base-content/70 gap-1">
                      <i class="bi bi-link-45deg me-1"></i
                      >{{ 'metadata.website.mementoApi' | translate }}
                    </span>
                    <span class="text-xs break-all">{{
                      result._source.archive?.memento_api_url || 'N/A'
                    }}</span>
                  </div>
                  @if (cdxApiUrl(); as cdxUrl) {
                    <div class="flex justify-between py-2 border-b border-base-300">
                      <span class="flex flex-row font-semibold text-base-content/70 gap-1">
                        <i class="bi bi-database me-1"></i
                        >{{ 'metadata.website.cdxApi' | translate }}
                      </span>
                      <span class="text-xs break-all">{{ cdxUrl }}</span>
                    </div>
                  }
                  <div class="flex justify-between items-center py-2 border-b border-base-300">
                    <span class="flex flex-row font-semibold text-base-content/70 gap-1">
                      <i class="bi bi-box-arrow-up-right me-1"></i
                      >{{ 'metadata.website.openSnapshot' | translate }}
                    </span>
                    <a
                      [href]="mementoUrlString()"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-primary hover:underline text-xs"
                    >
                      {{ 'metadata.website.openInNewTab' | translate }}
                      <i class="bi bi-arrow-right"></i>
                    </a>
                  </div>
                </div>
                @if (mementoUrl(); as url) {
                  <div class="relative mt-4">
                    @if (isIframeLoading() && !iframeError()) {
                      <div
                        class="absolute inset-0 flex items-center justify-center bg-base-200 rounded-lg border border-base-300 z-10"
                      >
                        <div class="flex flex-col items-center gap-3">
                          <span class="loading loading-spinner loading-lg text-primary"></span>
                          <p class="text-sm text-base-content/70">
                            {{ 'metadata.website.loadingSnapshot' | translate }}
                          </p>
                        </div>
                      </div>
                    }
                    @if (iframeError()) {
                      <div
                        class="absolute inset-0 flex items-center justify-center bg-base-200 rounded-lg border border-error z-10"
                      >
                        <div class="flex flex-col items-center gap-3 text-error">
                          <i class="bi bi-exclamation-triangle text-4xl"></i>
                          <p class="text-sm font-semibold">
                            {{ 'metadata.website.failedToLoad' | translate }}
                          </p>
                          <p class="text-xs text-base-content/60">
                            {{ 'metadata.website.archiveUnavailable' | translate }}
                          </p>
                        </div>
                      </div>
                    }
                    <iframe
                      [src]="url"
                      class="w-full h-[500px] border border-base-300 rounded-lg"
                      sandbox="allow-scripts allow-same-origin allow-popups"
                      referrerpolicy="no-referrer"
                      loading="eager"
                      [title]="'metadata.website.iframeTitle' | translate: { date: archiveDate() }"
                      (load)="onIframeLoad()"
                      (error)="onIframeError()"
                    ></iframe>
                  </div>
                }
                <p class="text-xs text-base-content/50 mt-3">
                  <i class="bi bi-info-circle me-1"></i>
                  {{ 'metadata.website.previewNote' | translate }}
                </p>
              }
            </div>
          </div>
        }
        @case ('metadata') {
          <div class="p-6">
            <div class="space-y-4">
              <h3 class="text-sm font-semibold uppercase text-base-content/60">
                {{ 'metadata.metadata' | translate }}
              </h3>
              @if (searchResult(); as result) {
                <div class="space-y-3 text-sm">
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="font-semibold text-base-content/70"
                      >{{ 'metadata.score' | translate }}:</span
                    >
                    <span>{{ result._score | number: '1.2-2' }}</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="font-semibold text-base-content/70"
                      >{{ 'metadata.documentId' | translate }}:</span
                    >
                    <span class="text-xs break-all">{{ result._id }}</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="font-semibold text-base-content/70"
                      >{{ 'metadata.mimeType' | translate }}:</span
                    >
                    <span>{{ result._source.capture.mimetype }}</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-base-300">
                    <span class="font-semibold text-base-content/70"
                      >{{ 'metadata.timestamp' | translate }}:</span
                    >
                    <span>{{ result._source.capture.timestamp }}</span>
                  </div>
                  <!-- Provider Section with Expandable Details -->
                  <div class="py-2 border-b border-base-300">
                    <div class="flex justify-between items-center">
                      <span class="font-semibold text-base-content/70"
                        >{{ 'metadata.provider' | translate }}:</span
                      >
                      <div class="flex items-center gap-2">
                        <span>{{ result._source.provider.domain }}</span>
                        @if (result._source.provider.id) {
                          <button
                            class="btn btn-xs btn-ghost text-primary"
                            (click)="toggleProviderDetails()"
                            [attr.aria-expanded]="showProviderDetails()"
                            aria-controls="provider-details"
                          >
                            <i
                              class="bi"
                              [class.bi-chevron-down]="!showProviderDetails()"
                              [class.bi-chevron-up]="showProviderDetails()"
                            ></i>
                            {{
                              showProviderDetails()
                                ? ('metadata.providerDetails.hideDetails' | translate)
                                : ('metadata.providerDetails.showDetails' | translate)
                            }}
                          </button>
                        }
                      </div>
                    </div>
                    <!-- Expandable Provider Details -->
                    @if (showProviderDetails()) {
                      <div id="provider-details" class="mt-4 p-4 bg-base-200 rounded-lg space-y-3">
                        <h4 class="text-sm font-semibold text-base-content/80">
                          {{ 'metadata.providerDetails.title' | translate }}
                        </h4>
                        @if (isLoadingProvider()) {
                          <div class="flex items-center gap-2 text-sm text-base-content/60">
                            <span class="loading loading-spinner loading-sm"></span>
                            {{ 'metadata.providerDetails.loading' | translate }}
                          </div>
                        } @else if (providerError()) {
                          <div class="text-sm text-error">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            {{ 'metadata.providerDetails.error' | translate }}
                          </div>
                        } @else if (providerDetails(); as provider) {
                          <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                              <span class="text-base-content/60"
                                >{{ 'metadata.providerDetails.name' | translate }}:</span
                              >
                              <span class="font-medium">{{ provider.name }}</span>
                            </div>
                            <div class="flex justify-between">
                              <span class="text-base-content/60"
                                >{{ 'metadata.providerDetails.id' | translate }}:</span
                              >
                              <span class="text-xs font-mono">{{ provider.id }}</span>
                            </div>
                            @if (provider.domains && provider.domains.length > 0) {
                              <div>
                                <span class="text-base-content/60 block mb-1"
                                  >{{ 'metadata.providerDetails.domains' | translate }}:</span
                                >
                                <div class="flex flex-wrap gap-1">
                                  @for (domain of provider.domains; track domain) {
                                    <span class="badge badge-sm badge-primary badge-outline">{{
                                      domain
                                    }}</span>
                                  }
                                </div>
                              </div>
                            }
                            @if (provider.url_patterns && provider.url_patterns.length > 0) {
                              <div>
                                <span class="text-base-content/60 block mb-1"
                                  >{{ 'metadata.providerDetails.urlPatterns' | translate }}:</span
                                >
                                <div class="space-y-1">
                                  @for (pattern of provider.url_patterns; track pattern) {
                                    <code
                                      class="block text-xs bg-base-100 px-2 py-1 rounded break-all"
                                      >{{ pattern }}</code
                                    >
                                  }
                                </div>
                              </div>
                            }
                            @if (provider.priority !== undefined) {
                              <div class="flex justify-between">
                                <span class="text-base-content/60"
                                  >{{ 'metadata.providerDetails.priority' | translate }}:</span
                                >
                                <span>{{ provider.priority }}</span>
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        }
        @case ('related') {
          <div class="p-6">
            <div class="space-y-4">
              <h3 class="text-sm font-semibold uppercase text-base-content/60">
                {{ 'metadata.relatedSerps' | translate }}
              </h3>
              @if (isLoadingDetails()) {
                <div class="flex items-center justify-center py-8">
                  <span class="loading loading-spinner loading-md text-primary"></span>
                </div>
              } @else if (relatedSerps().length > 0) {
                <div class="flex flex-col gap-4">
                  @for (serp of relatedSerps(); track serp._id) {
                    <aql-panel
                      [panelTitle]="serp._source.url_query"
                      [subtitle]="serp._source.capture.url"
                      [bordered]="true"
                      [shadow]="true"
                      [rounded]="true"
                      class="cursor-pointer hover:shadow-lg transition-shadow duration-200 rounded-2xl"
                      tabindex="0"
                      role="button"
                      (click)="onRelatedSerpClick(serp)"
                      (keydown.enter)="onRelatedSerpClick(serp)"
                      (keydown.space)="onRelatedSerpClick(serp)"
                    >
                      <div footer class="flex items-center gap-2 text-xs text-base-content/60">
                        <span>
                          {{ formatDate(serp._source.capture.timestamp) }}
                        </span>
                        <span>Â·</span>
                        <span>
                          {{ serp._source.provider.domain }}
                        </span>
                      </div>
                    </aql-panel>
                  }
                </div>
              } @else {
                <div class="text-center py-8 text-base-content/50">
                  <i class="bi bi-search text-4xl mb-3 block"></i>
                  <p>{{ 'metadata.noRelatedSerps' | translate }}</p>
                </div>
              }
            </div>
          </div>
        }
        @case ('unfurl') {
          <div class="p-6">
            <div class="space-y-4">
              <div class="flex justify-between items-center">
                <h3 class="text-sm font-semibold uppercase text-base-content/60">
                  {{ 'metadata.urlDetails' | translate }}
                </h3>
                @if (unfurlWebUrl()) {
                  <a
                    [href]="unfurlWebUrl()"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center gap-1 text-sm text-primary hover:underline"
                  >
                    {{ 'metadata.unfurl.viewInUnfurlTool' | translate }}
                    <i class="bi bi-box-arrow-up-right"></i>
                  </a>
                }
              </div>
              @if (isLoadingDetails()) {
                <div class="flex items-center justify-center py-8">
                  <span class="loading loading-spinner loading-md text-primary"></span>
                </div>
              } @else if (unfurlData(); as unfurl) {
                <div class="unfurl-view space-y-4">
                  <!-- Base URL -->
                  <div class="unfurl-section">
                    <h4 class="text-xs font-semibold uppercase text-base-content/50 mb-2">
                      {{ 'metadata.unfurl.baseUrl' | translate }}
                    </h4>
                    <p class="text-sm font-mono break-all text-base-content">
                      {{ unfurl.scheme }}://{{ unfurl.netloc }}
                      @if (unfurl.port) {
                        :{{ unfurl.port }}
                      }
                    </p>
                  </div>

                  <!-- Path -->
                  <div class="unfurl-section">
                    <h4 class="text-xs font-semibold uppercase text-base-content/50 mb-2">
                      {{ 'metadata.unfurl.path' | translate }}
                    </h4>
                    <p class="text-sm font-mono break-all text-base-content">
                      {{ unfurl.path || '/' }}
                    </p>
                  </div>

                  <!-- Query Parameters -->
                  @if (getQueryParamEntries().length > 0) {
                    <div class="unfurl-section">
                      <h4 class="text-xs font-semibold uppercase text-base-content/50 mb-2">
                        {{ 'metadata.unfurl.queryParams' | translate }}
                      </h4>
                      <div class="overflow-x-auto">
                        <table class="table table-sm w-full">
                          <thead>
                            <tr class="border-b border-base-300">
                              <th class="text-left font-semibold text-base-content/70">
                                {{ 'metadata.unfurl.parameter' | translate }}
                              </th>
                              <th class="text-left font-semibold text-base-content/70">
                                {{ 'metadata.unfurl.value' | translate }}
                              </th>
                            </tr>
                          </thead>
                          <tbody>
                            @for (param of getQueryParamEntries(); track param.key) {
                              <tr class="border-b border-base-300/50">
                                <td class="font-mono text-sm text-primary">{{ param.key }}</td>
                                <td class="font-mono text-sm break-all">{{ param.value }}</td>
                              </tr>
                            }
                          </tbody>
                        </table>
                      </div>
                    </div>
                  }

                  <!-- Fragment -->
                  @if (unfurl.fragment) {
                    <div class="unfurl-section">
                      <h4 class="text-xs font-semibold uppercase text-base-content/50 mb-2">
                        {{ 'metadata.unfurl.fragment' | translate }}
                      </h4>
                      <p class="text-sm font-mono break-all text-base-content">
                        #{{ unfurl.fragment }}
                      </p>
                    </div>
                  }
                </div>
              } @else {
                <div class="text-center py-8 text-base-content/50">
                  <i class="bi bi-link-45deg text-4xl mb-3 block"></i>
                  <p>{{ 'metadata.noUnfurlData' | translate }}</p>
                </div>
              }
            </div>
          </div>
        }
      }
    </div>
  </div>
</div>
