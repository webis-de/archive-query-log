<div>
  <aql-dropdown position="bottom end" [contentWidth]="'350px'">
    <div trigger class="relative">
      <aql-button
        btnType="primary"
        iconStyle="circle"
        size="md"
        iconBefore=""
        [aqlTooltip]="
          isOpen() ? ('tooltip.filter.close' | translate) : ('tooltip.filter.open' | translate)
        "
        [tooltipPosition]="'right'"
        [attr.aria-label]="
          isOpen() ? ('tooltip.filter.close' | translate) : ('tooltip.filter.open' | translate)
        "
      >
        <i
          class="bi text-3xl transition-transform duration-300 ease-in-out"
          [ngClass]="isOpen() ? 'bi-x rotate-180' : 'bi-filter rotate-0'"
        ></i>
      </aql-button>
    </div>
    <ng-container content>
      <div
        tabindex="0"
        class="text-left"
        (click)="$event.stopPropagation()"
        (mousedown)="$event.stopPropagation()"
        (keydown)="$event.stopPropagation()"
      >
        <div class="p-2 border-b border-base-300">
          <div class="flex gap-4">
            <div class="flex-1">
              <span class="block text-sm font-bold text-base-content/60 mb-1">{{
                'filter.from' | translate
              }}</span>
              <aql-input-field
                type="date"
                [showIcon]="false"
                size="sm"
                [value]="dateFrom()"
                [max]="maxDateFrom()"
                (change)="updateDateFrom($any($event.target).value)"
                class="w-full"
              ></aql-input-field>
            </div>
            <div class="flex-1">
              <span class="block text-sm font-bold text-base-content/60 mb-1">{{
                'filter.to' | translate
              }}</span>
              <aql-input-field
                type="date"
                [showIcon]="false"
                size="sm"
                [value]="dateTo()"
                [min]="minDateTo()"
                [max]="maxDateTo()"
                (change)="updateDateTo($any($event.target).value)"
                class="w-full"
              ></aql-input-field>
            </div>
          </div>
        </div>

        <div class="p-2 border-b border-base-300">
          <span class="block text-sm font-bold text-base-content/60 mb-3">{{
            'filter.websiteStatus' | translate
          }}</span>
          <div class="flex flex-row items-center gap-4">
            <aql-radio-button
              name="statusGroup"
              [label]="'filter.any' | translate"
              value="any"
              size="sm"
              [checked]="status() === 'any'"
              (click)="updateStatus('any')"
            ></aql-radio-button>
            <aql-radio-button
              name="statusGroup"
              [label]="'filter.active' | translate"
              value="active"
              size="sm"
              [checked]="status() === 'active'"
              (click)="updateStatus('active')"
            ></aql-radio-button>
            <aql-radio-button
              name="statusGroup"
              [label]="'filter.inactive' | translate"
              value="inactive"
              size="sm"
              [checked]="status() === 'inactive'"
              (click)="updateStatus('inactive')"
            ></aql-radio-button>
          </div>
        </div>

        <div class="p-2 pb-6">
          <span class="block text-sm font-bold text-base-content/60 mb-3">{{
            'filter.searchProviders' | translate
          }}</span>

          <!-- Loading state -->
          @if (isLoadingProviders()) {
            <div class="flex items-center justify-center py-4">
              <span class="loading loading-spinner loading-sm mr-2"></span>
              <span class="text-sm text-base-content/60">{{
                'filter.loadingProviders' | translate
              }}</span>
            </div>
          }

          <!-- Error state -->
          @if (providerLoadError() && !isLoadingProviders()) {
            <div class="text-sm text-error py-2">
              {{ 'filter.providerLoadError' | translate }}
            </div>
          }

          <!-- Provider list -->
          @if (!isLoadingProviders()) {
            <!-- Search input for filtering providers -->
            @if (providers().length > 6) {
              <div class="mb-3">
                <aql-input-field
                  type="text"
                  [showIcon]="true"
                  size="sm"
                  [placeholder]="'filter.searchProvidersPlaceholder' | translate"
                  [value]="providerSearch()"
                  (input)="updateProviderSearch($any($event.target).value)"
                  class="w-full"
                ></aql-input-field>
              </div>
            }

            <!-- Selected count indicator -->
            @if (selectedProviderCount() > 0) {
              <div class="text-xs text-base-content/60 mb-2">
                {{ 'filter.selectedCount' | translate: { count: selectedProviderCount() } }}
              </div>
            }

            <div class="flex flex-col gap-2 max-h-48 overflow-y-auto pr-1">
              @for (provider of filteredProviders(); track provider.id) {
                <div>
                  <aql-checkbox
                    [label]="provider.label"
                    size="sm"
                    [checked]="provider.checked"
                    (checkboxChange)="updateProviderCheckedByLabel(provider.label, $event)"
                  ></aql-checkbox>
                </div>
              }
              @if (filteredProviders().length === 0 && providerSearch()) {
                <div class="text-sm text-base-content/60 py-2">
                  {{ 'filter.noProvidersFound' | translate }}
                </div>
              }
            </div>
          }
        </div>

        <div class="flex border-t border-base-300 p-2 justify-between gap-3">
          <aql-button btnType="default" size="sm" (click)="reset()">
            {{ 'filter.reset' | translate }}
          </aql-button>
          <aql-button btnType="primary" size="sm" (click)="apply($event)">
            {{ 'filter.apply' | translate }}
          </aql-button>
        </div>
      </div>
    </ng-container>
  </aql-dropdown>
</div>
